<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="contentsMapper">

    <!-- Contents 조회 -->
<!--    <select id="getAllContents" resultType="com.culturemoa.cultureMoaProject.board.dto.ContentsDTO" >-->
<!--        SELECT CONT.IDX, CONT.USER_IDX, CONT.CATEGORY_IDX, CONT.TITLE, CONT.DIVISION,-->
<!--               CONT.CONTENT, CONT.SDATE-->
<!--        FROM CONTENTS_TBL CONT-->
<!--        LEFT OUTER JOIN USER_TBL USERT ON-->
<!--             CONT.USER_IDX = USERT.IDX-->
<!--    </select>-->

    <!-- CONTENTS_TBL의 content와 USER_TBL의 유저 정보 조인
    edate는 끝 날짜라 값이 있으면 안됨 그래서 null이어야 함 -->
    <select id="getContentInfos" resultType="com.culturemoa.cultureMoaProject.board.dto.ContentInfoDTO" >
        SELECT CONT.IDX, CONT.USER_IDX, CONT.CATEGORY_IDX, CONT.TITLE, CONT.DIVISION,
        CONT.CONTENT, CONT.SDATE,
        USERT.NICKNAME
        FROM CONTENTS_TBL CONT
        LEFT OUTER JOIN USER_TBL USERT ON
        CONT.USER_IDX = USERT.IDX
        WHERE CONT.EDATE = NULL
    </select>

    <!-- CONTENTS_TBL의 검색어 조회 - search -->
    <select id="getContentKeywordSearch" resultType="com.culturemoa.cultureMoaProject.board.dto.ContentInfoDTO" >
        SELECT CONT.IDX, CONT.USER_IDX, CONT.CATEGORY_IDX, CONT.TITLE, CONT.DIVISION,
        CONT.CONTENT, CONT.SDATE,
        USERT.NICKNAME,
        CATE.NAME
        FROM CONTENTS_TBL CONT
        LEFT OUTER JOIN USER_TBL USERT ON CONT.USER_IDX = USERT.IDX
        LEFT OUTER JOIN USER_TBL CATE ON

        <!--        WHERE CONT.EDATE = NULL -->
        <where>
            <!-- edate: 종료일/삭제일로 삭제되지 않았거나, 아직 유효한 게시글만 보여주는 필터 조건이고,
                DB에서 삭제하지 않고 EDATE에 날짜만 남기는 방식임 -->
            CONT.EDATE IS NULL
            <!-- Contents_tbl의 category, title, sdate와 USER_tbl의 nickname을 키워드로 검색 -->
<!--            <if test="keyword != null and keyword != ''">-->
<!--                &lt;!&ndash; CAST(CONT.CATEGORY_IDX AS CHAR)-->
<!--                     : CONT.CATEGORY_IDX가 숫자일 경우 문자열로 형변환하여 출력&ndash;&gt;-->
<!--                AND (CAST(CONT.CATEGORY_IDX AS CHAR) LIKE concat('%', #{keyword}, '%')-->
<!--                 OR CONT.TITLE LIKE concat('%', #{keyword}, '%')-->
<!--                 OR CONT.SDATE LIKE concat('%', #{keyword}, '%')-->
<!--                 OR USERT.NICKNAME LIKE concat('%', #{keyword}, '%'))-->
<!--            </if>-->
            <!-- '팝니다', '삽니다' 선택한 핉터 -->
            <if test="division != null and division != ''">
                <!-- Contents_tbl의 division -->
                AND CONT.DIVISION = #{division}
            </if>
            <!-- "keyword != null and keyword != ''"
                 : 키워드 검색 - keyword가 Null이 아니고, 빈 문자열 입력 방지하는 조건 -->
            <if test="keyword != null and keyword != ''">
                <!-- Contents_tbl의 category, title, division, sdate와 USER_tbl의 nickname을 키워드로 검색 -->
                AND (
                    CONT.DIVISION LIKE CONCAT('%', #{keyword}, '%')
                    OR CONT.TITLE LIKE CONCAT('%', #{keyword}, '%')
                    OR CONT.SDATE LIKE CONCAT('%', #{keyword}, '%')
                    OR USERT.NICKNAME LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>

        </where>

    </select>

    <!-- CONTENTS_TBL의 게시글 등록 insert -->
<!--    <insert id="getContentInsert" useGeneratedKeys="true"-->
<!--            parameterType="com.culturemoa.cultureMoaProject.board.dto.ContentsDTO"-->
<!--            keyProperty="idx" >-->
<!--        INSERT INTO CONTENTS_TBL (USER_IDX, CATEGORY_IDX, TITLE, DIVISION, CONTENT, SDATE)-->
<!--        VALUES( #{user_idx}, #{category_idx}, #{title}, #{division}, #{content}, #{sdate});-->
<!--    </insert>-->

</mapper>