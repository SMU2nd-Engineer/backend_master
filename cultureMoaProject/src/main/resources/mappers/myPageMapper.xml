<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myPageMapper">

<!--    유저 id를 이용하여 패스워드 가져오기    -->
    <select id="findPasswordByTokenId" parameterType="String" resultType="com.culturemoa.cultureMoaProject.user.dto.MyPagePasswordCheckDTO">
        select PASSWORD from USER_TBL where ID = #{id} and WDATE is null
    </select>

<!--    유저 id를 이용하여 소셜 정보 가져옴    -->
    <select id="findSocialLoginByTokenId" parameterType="String" resultType="com.culturemoa.cultureMoaProject.user.dto.MyPageCheckSocialDTO" >
    <!--   별칭 지정으로 dto와 맞춤     -->
        select SOCIAL_LOGIN as socialLogin from USER_TBL where ID=#{tokenUserId} and WDATE is null
    </select>

    <!--  유저 id를 이용하여 사용자 정보를 가져옴  -->
    <select id="findUserInfoByTokenId" parameterType="String" resultType="com.culturemoa.cultureMoaProject.user.dto.MyPageGetUserInfoDTO" >
        select NAME, NICKNAME, ADDRESS, EMAIL from USER_TBL where ID=#{tokenUserId} and WDATE is null
    </select>

<!--  유저 아이디를 통해서 마이페이지 갱신된 정보를 업데이트  -->
    <update id="updateUserInfo" parameterType="com.culturemoa.cultureMoaProject.user.dto.MyPageUpdateUserInfoDTO" >
        update USER_TBL
        <set>
            NAME=#{name}, NICKNAME=#{nickName}, EMAIL=#{email}, ADDRESS=#{address}, EDATE = #{eDate},
            <if test="password !='' and password != null">
                password=#{password}
            </if>
        </set>
        where ID = #{id} and WDATE is null
    </update>

<!--  마이페이지 찜 목록 정보 가져오기  -->
    <select id="getWishListInfo" parameterType="String" resultType="com.culturemoa.cultureMoaProject.user.dto.MyPageProductListDTO">
        select P.IDX, P.TITLE, P.PRICE, P.FLAG, PD.CONTENT, PD.IMAGE_URL as imageUrl
        from USER_PICK_TBL as UP
        join USER_TBL as U on U.IDX = UP.USER_IDX
        join PRODUCT_TBL as P on P.IDX = UP.PRODUCT_IDX
        join PRODUCT_DETAIL_TBL AS PD on PD.PRODUCT_IDX = P.IDX
        where U.ID = #{userId}
        order by UP.SDATE DESC;
    </select>

<!--  마이페이지 메인에서 별점에 표시한 점수를 가져오기  -->
    <select id="getTotalRating" parameterType="String" resultType="com.culturemoa.cultureMoaProject.user.dto.MyPageTotalRatingDTO" >
        select sum(RATING) as myPageTotalRating, count(*) as totalRatingCount
        from USER_REVIEW_TBL as UR
        join USER_TBL as U on U.IDX = UR.USER_IDX
        where U.ID = #{userId}
    </select>

<!--  마이페이지 메인에서 찜 목록 최신 2개만 가져오기  -->
    <select id="getMainPeakListInfo" parameterType="String" resultType="com.culturemoa.cultureMoaProject.user.dto.MyPageProductListDTO">
        select P.IDX, P.TITLE, P.PRICE, P.FLAG, PD.CONTENT, PD.IMAGE_URL as imageUrl
        from USER_PICK_TBL as UP
        join USER_TBL as U on U.IDX = UP.USER_IDX
        join PRODUCT_TBL as P on P.IDX = UP.PRODUCT_IDX
        join PRODUCT_DETAIL_TBL AS PD on PD.PRODUCT_IDX = P.IDX
        where U.ID = #{userId}
        order by UP.SDATE DESC;
        limit 2;
    </select>
<!--  마이페이지에 거래 내역에서 판매한 상품 목록을 가져오기  -->
    <select id="getMySellListInfo" parameterType="String" resultType="com.culturemoa.cultureMoaProject.user.dto.MyPageProductListDTO" >
        select P.IDX, P.TITLE, P.PRICE, P.FLAG, PD.CONTENT, PD.IMAGE_URL as imageUrl
        from USER_TRANSACTION_TBL as UT
        join USER_TBL as U on U.IDX = UT.USER_IDX
        join PRODUCT_TBL as P on P.IDX = UT.PRODUCT_IDX
        join PRODUCT_DETAIL_TBL AS PD on PD.PRODUCT_IDX = P.IDX
        where U.ID = #{userId} and UT.DIVISION = 0
        order by UT.SDATE DESC;
    </select>
<!--  마이페이지에 거래 내역에서 구매한 상품 목록을 가져오기  -->
    <select id="getMyBuyListInfo" parameterType="String" resultType="com.culturemoa.cultureMoaProject.user.dto.MyPageProductListDTO" >
        select P.IDX, P.TITLE, P.PRICE, P.FLAG, PD.CONTENT, PD.IMAGE_URL as imageUrl
        from USER_TRANSACTION_TBL as UT
        join USER_TBL as U on U.IDX = UT.USER_IDX
        join PRODUCT_TBL as P on P.IDX = UT.PRODUCT_IDX
        join PRODUCT_DETAIL_TBL AS PD on PD.PRODUCT_IDX = P.IDX
        where U.ID = #{userId} and UT.DIVISION = 1
        order by UT.SDATE DESC;
    </select>
</mapper>